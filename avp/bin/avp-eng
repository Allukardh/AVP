#!/opt/bin/python3
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-ENG
# File      : avp-eng
# Role      : Multi-Device VPN Failover (Engine) â€” Python core
# Version   : v2.1.0 (2026-02-20)
# Status    : experimental
# =============================================================
SCRIPT_VER = "v2.1.0"

import os
import sys
import subprocess
from avp.lib.avp_lib import log_event, log_error

LEGACY_ENG = os.environ.get("AVP_ENG_SH", "/jffs/scripts/avp-eng.sh")

def log_start(cmd: str) -> None:
    log_event("ENG", f"start {cmd}")

def log_end(cmd: str, rc: int) -> None:
    if rc == 0:
        log_event("ENG", f"end {cmd} rc={rc}", rc=rc)
    else:
        log_error("ENG", f"end {cmd} rc={rc}", rc=rc)

def call_legacy(args: list) -> int:
    if not os.path.isfile(LEGACY_ENG) or not os.access(LEGACY_ENG, os.X_OK):
        log_error("ENG", f"legacy engine not found: {LEGACY_ENG}", rc=127)
        return 127
    try:
        proc = subprocess.run([LEGACY_ENG] + args)
        return proc.returncode
    except KeyboardInterrupt:
        return 130
    except Exception as e:
        log_error("ENG", f"execution failed: {e}", rc=1)
        return 1

def main(argv: list) -> int:
    if not argv:
        return call_legacy(["--help"])
    cmd, subargs = argv[0], argv[1:]
    log_start(cmd)
    rc = call_legacy([cmd] + subargs)
    log_end(cmd, rc)
    return rc

if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
