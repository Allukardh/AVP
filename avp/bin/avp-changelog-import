#!/opt/bin/python3
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-CHANGELOG-IMPORT
# File      : avp-changelog-import
# Role      : Migration helper (import legacy changelog from minified .sh and normalize minified .md)
# Version   : v2.0.1 (2026-02-18)
# Status    : stable
# =============================================================
SCRIPT_VER = "v2.0.1"

import argparse
import re
import sys
from typing import List, Tuple, Optional

# -------- md normalizer --------
def normalize_md(text: str) -> str:
    t = (text or "").strip()
    if not t:
        return ""
    t = re.sub(r"\s##\s+", "\n\n## ", t)
    t = re.sub(r"\n{3,}", "\n\n", t)
    # bullets colados após header
    t = re.sub(r"\)\s+-\s+", ")\n- ", t)
    t = re.sub(r"\)\s+\*\s+", ")\n- ", t)
    # garante newline final única
    return t.rstrip() + "\n"

# -------- legacy .sh importer (robusto para minificado) --------
# Estratégia: split por '#' (comentários), porque em minificado ainda existem '#'
# Detecta:
#  - header de versão: "- v1.0.0 (YYYY-MM-DD): msg" ou "- 1.0.0 (...) : msg" ou "v1.0.0 (...)"
#  - bullets: "* FIX: ..." ou "- FIX: ..." (vira "- ...")
RE_VER = re.compile(r"^(?:-\s*)?(?:v)?(\d+\.\d+\.\d+)\s*\((\d{4}-\d{2}-\d{2})\)\s*:?\s*(.*)$")
RE_BUL = re.compile(r"^(?:\*\s*|-)\s*(.+)$")

def import_from_sh(component: str, sh_text: str) -> str:
    raw = sh_text.replace("\r\n", "\n").replace("\r", "\n")
    parts = [p.strip() for p in raw.split("#") if p.strip()]

    in_changelog = False
    cur_ver: Optional[str] = None
    cur_date: Optional[str] = None
    entries: List[Tuple[str, str, List[str]]] = []

    def start(ver: str, date: str, first_msg: str) -> None:
        nonlocal cur_ver, cur_date, entries
        cur_ver, cur_date = ver, date
        bullets: List[str] = []
        if first_msg:
            bullets.append(first_msg.strip())
        entries.append((ver, date, bullets))

    def add_bullet(msg: str) -> None:
        if not entries:
            return
        msg = msg.strip()
        if not msg:
            return
        # evita duplicar idêntico colado
        if entries[-1][2] and entries[-1][2][-1] == msg:
            return
        entries[-1][2].append(msg)

    for p in parts:
        # liga modo changelog quando encontrar token
        if "CHANGELOG" in p.upper():
            in_changelog = True
            continue
        if not in_changelog:
            continue

        # para quando chegar no SCRIPT_VER (fim típico do bloco de header)
        if p.strip().startswith("SCRIPT_VER"):
            break

        # normaliza espaços
        p2 = " ".join(p.split())

        m = RE_VER.match(p2)
        if m:
            ver, date, rest = m.group(1), m.group(2), (m.group(3) or "").strip()
            start(ver, date, rest)
            continue

        # bullets após um header de versão (mesmo colados)
        mb = RE_BUL.match(p2)
        if mb and entries:
            add_bullet(mb.group(1))
            continue

    out: List[str] = [f"# {component}", ""]
    if not entries:
        out += ["(sem entradas detectadas no legado)", ""]
        return "\n".join(out).rstrip() + "\n"

    # respeita ordem encontrada (normalmente do mais novo pro mais antigo no header)
    for ver, date, bul in entries:
        out.append(f"## v{ver} ({date})")
        if bul:
            for b in bul:
                out.append(f"- {b}")
        else:
            out.append("- (sem detalhes)")
        out.append("")
    return "\n".join(out).rstrip() + "\n"

def main(argv: List[str]) -> int:
    ap = argparse.ArgumentParser(add_help=False)
    ap.add_argument("--help", action="store_true")
    ap.add_argument("--component", type=str, default="")
    ap.add_argument("--from", dest="src", choices=("sh","md","auto"), default="auto")
    ns = ap.parse_args(argv)

    if ns.help or not ns.component:
        sys.stdout.write(
            "Usage:\n"
            "  avp-changelog-import --component AVP-XXX --from sh|md|auto < input > out.md\n"
        )
        return 0 if ns.help else 2

    data = sys.stdin.read()

    if ns.src == "md" or (ns.src == "auto" and data.lstrip().startswith("# ")):
        if not data.lstrip().startswith("# "):
            data = f"# {ns.component}\n\n" + data
        sys.stdout.write(normalize_md(data))
        return 0

    # default: sh
    sys.stdout.write(import_from_sh(ns.component, data))
    return 0

if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
