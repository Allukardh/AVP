#!/opt/bin/python3
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-ENTRY
# File      : avp
# Role      : Entrypoint dispatcher (V2) for AVP tools
# Version   : v1.0.0 (2026-02-17)
# Status    : stable
# =============================================================

SCRIPT_VER="v1.0.0"

import os
import shutil
import subprocess
import sys
from pathlib import Path
from typing import List, Optional, Tuple

SELF = Path(__file__).resolve()
BIN_DIR = SELF.parent
AVP_ROOT = BIN_DIR.parent
REPO_ROOT = AVP_ROOT.parent

# Subcomandos canônicos (Python-first)
SUBS = {
    "meta":  "avp-meta",
    "commit":"avp-commit",
    "tag":   "avp-tag",
    "smoke": "avp-smoke",
    "apply": "avp-apply",
}

def _die(msg: str, rc: int = 2) -> int:
    print(f"ERR: {msg}", file=sys.stderr)
    return rc

def _find_exe(name: str) -> Optional[str]:
    # prioridade: avp/bin/<tool> (SSOT local)
    p = (BIN_DIR / name)
    if p.exists() and os.access(p, os.X_OK):
        return str(p)

    # fallback: PATH (entware/host)
    w = shutil.which(name)
    if w and os.access(w, os.X_OK):
        return w

    return None

def _git_short() -> str:
    try:
        r = subprocess.run(
            ["git", "rev-parse", "--short", "HEAD"],
            cwd=str(REPO_ROOT),
            stdout=subprocess.PIPE,
            stderr=subprocess.DEVNULL,
            text=True,
            check=False,
        )
        s = (r.stdout or "").strip()
        return s if s else "unknown"
    except Exception:
        return "unknown"

def _help() -> None:
    print(
        "Usage:\n"
        "  avp --help\n"
        "  avp --version\n"
        "\n"
        "Python-first tools:\n"
        "  avp meta   <args...>\n"
        "  avp commit <args...>\n"
        "  avp tag    <args...>\n"
        "  avp smoke  <args...>\n"
        "  avp apply  <args...>\n"
        "\n"
        "Notes:\n"
        "- Dispatcher V2: apenas encaminha para os binários em ./avp/bin.\n"
        "- PATH já inclui /jffs/scripts/avp/bin no teu bootstrap.\n"
    )

def main(argv: List[str]) -> int:
    if not argv or argv[0] in ("--help", "-h", "help"):
        _help()
        return 0

    if argv[0] in ("--version", "-V", "version"):
        print(f"AVP-ENTRY {SCRIPT_VER} (git={_git_short()})")
        return 0

    sub = argv[0]
    tool = SUBS.get(sub)
    if not tool:
        return _die(f"subcomando inválido: {sub} (use --help)")

    exe = _find_exe(tool)
    if not exe:
        return _die(f"{tool} não encontrado/executável em {BIN_DIR} nem no PATH")

    os.execv(exe, [exe] + argv[1:])  # no return

if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
