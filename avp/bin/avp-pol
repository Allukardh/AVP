#!/opt/bin/python3
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-POL
# File      : avp-pol
# Role      : Policy Controller (Python wrapper)
# Version   : v2.0.0 (2026-02-20)
# Status    : experimental
# =============================================================
SCRIPT_VER = "v2.0.0"

import os
import sys
import subprocess
from avp.lib.avp_lib import log_event, log_error

LEGACY_POL = os.environ.get("AVP_POL_SH", "/jffs/scripts/avp-pol.sh")

def log_start(cmd: str) -> None:
    log_event("POL", f"start {cmd}")

def log_end(cmd: str, rc: int) -> None:
    if rc == 0:
        log_event("POL", f"end {cmd} rc={rc}", rc=rc)
    else:
        log_error("POL", f"end {cmd} rc={rc}", rc=rc)

def call_legacy(args: list) -> int:
    if not os.path.isfile(LEGACY_POL) or not os.access(LEGACY_POL, os.X_OK):
        log_error("POL", f"legacy policy not found: {LEGACY_POL}", rc=127)
        return 127
    try:
        proc = subprocess.run([LEGACY_POL] + args)
        return proc.returncode
    except KeyboardInterrupt:
        return 130
    except Exception as e:
        log_error("POL", f"execution failed: {e}", rc=1)
        return 1

def main(argv: list) -> int:
    if not argv:
        return call_legacy(["--help"])
    cmd = argv[0]
    subargs = argv[1:]
    log_start(cmd)
    rc = call_legacy([cmd] + subargs)
    log_end(cmd, rc)
    return rc

if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
