#!/bin/sh
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-BOOT
# File      : post-mount
# Role      : post-mount helper (Entware /opt bind)
# Version   : v1.0.6 (2026-01-26)
# Status    : stable
# =============================================================
#
# CHANGELOG
# - v1.0.6 (2026-01-26)
#   * VERSION: bump patch (pos harden canônico)
# - v1.0.5 (2026-01-18)
#   * POLISH: padroniza SCRIPT_VER + set -u (ordem oficial) e remove linhas em branco desnecessarias
# - v1.0.4 (2025-12-26)
#   * CHORE: polimento preparatório pra GUI (suite alinhada)
# - v1.0.3 (2025-12-23)
#   * CHORE: consolidacao historica (Etapa B) + normaliza rotulos (BASE/STD/CHORE)
# - v1.0.2 (2025-12-23)
#   * CHORE: changelog hygiene (padrao STD/ADD + consistencia textual)
# - v1.0.1 (2025-12-23)
#   * STD: padroniza header + bloco CHANGELOG (Etapa A)
# - v1.0.0 (2025-12-23)
#   * BASE: bind mount do Entware para /opt no evento post-mount
# =============================================================

SCRIPT_VER="v1.0.6"
export PATH="/jffs/scripts:/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin:${PATH:-}"
hash -r 2>/dev/null || true
set -u

ENT_MNT="/tmp/mnt/Entware"
ENT_SUB="/tmp/mnt/Entware/entware"
OPT_REAL="/tmp/opt"

# Só age quando a partição Entware estiver montada
mount | grep -q "on ${ENT_MNT} " || exit 0

# Root real do Entware
if [ -d "$ENT_SUB" ]; then
  ENT_ROOT="$ENT_SUB"
else
  ENT_ROOT="$ENT_MNT"
fi

# Checagem: só segue se existir opkg
[ -x "$ENT_ROOT/bin/opkg" ] || [ -x "$ENT_ROOT/sbin/opkg" ] || exit 0

mkdir -p "$OPT_REAL"

# Monta apenas se ainda não estiver montado
if ! mount | grep -q "on ${OPT_REAL} "; then
  mount --bind "$ENT_ROOT" "$OPT_REAL" 2>/dev/null || mount -o bind "$ENT_ROOT" "$OPT_REAL"
fi

logger -t AVP-BOOT "post-mount: Entware OK ($ENT_ROOT -> /opt)"
