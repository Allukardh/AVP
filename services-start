#!/bin/sh
# =============================================================
# AutoVPN Platform (AVP)
# Component : AVP-BOOT
# File      : services-start
# Role      : Firmware boot hook (AVP startup orchestration + cron/webui-feed)
# Version   : v1.1.26 (2026-02-20)
# Status    : stable
# =============================================================

SCRIPT_VER="v1.1.26"
export PATH="/jffs/scripts:/jffs/scripts/avp/bin:/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin:${PATH:-}"
export GIT_PAGER=cat PAGER=cat
hash -r 2>/dev/null || true
set -u

#
KH="/jffs/.ssh/known_hosts"
[ -f "$KH" ] || : >"$KH" 2>/dev/null || :
chmod 600 "$KH" 2>/dev/null || :

# non-blocking: timeout curto; ignora rc (GitHub retorna 1 no -T)
if [ -x /opt/bin/ssh ] && [ -f /jffs/.ssh/id_ed25519 ]; then
  /opt/bin/ssh \
    -o BatchMode=yes \
    -o ConnectTimeout=5 \
    -o StrictHostKeyChecking=accept-new \
    -o UserKnownHostsFile=/jffs/.ssh/known_hosts \
    -o IdentitiesOnly=yes \
    -i /jffs/.ssh/id_ed25519 \
    -T git@github.com >/dev/null 2>&1 || :
fi

# --- SSH HOME FIX (GitHub) - pre boot settle ---
[ -d /jffs/.ssh ] || mkdir -p /jffs/.ssh 2>/dev/null || :
chmod 700 /jffs/.ssh 2>/dev/null || :
if [ -d /root/.ssh ] && [ ! -L /root/.ssh ]; then
  rm -rf /root/.ssh 2>/dev/null || :
fi
[ -L /root/.ssh ] || ln -sf /jffs/.ssh /root/.ssh 2>/dev/null || :

[ -f /jffs/.ssh/known_hosts ] && chmod 600 /jffs/.ssh/known_hosts 2>/dev/null || :
[ -f /jffs/.ssh/authorized_keys ] && chmod 600 /jffs/.ssh/authorized_keys 2>/dev/null || :
[ -f /jffs/.ssh/id_ed25519 ] && chmod 600 /jffs/.ssh/id_ed25519 2>/dev/null || :
[ -f /jffs/.ssh/id_ed25519.pub ] && chmod 644 /jffs/.ssh/id_ed25519.pub 2>/dev/null || :

# Aguarda o sistema estabilizar após boot
sleep 60

# Evita duplicidade (reboot / restart de serviços)
cru d AVP-POL 2>/dev/null

# Failover multi-dispositivo a cada 5 minutos
# (AVP-POL decide se executa ou não, via AUTOVPN_ENABLED em global.conf)
# (saída do cron é silenciada propositalmente)
cru a AVP-POL "*/5 * * * * /bin/sh /jffs/scripts/avp/bin/avp-pol-cron.sh"
AVP_ENG_ROTATE_PAYLOAD='export PATH="/jffs/scripts:/jffs/scripts/avp/bin:/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin"; export GIT_PAGER=cat PAGER=cat; /jffs/scripts/avp/bin/avp-eng.sh --rotate-usb >/dev/null 2>&1'
cru d AVP-ENG-ROTATE 2>/dev/null || :
cru a AVP-ENG-ROTATE "58 5 * * * /bin/sh -c '$AVP_ENG_ROTATE_PAYLOAD'"

# AVP WebUI feeder (static JSON endpoint for WebUI)

# --- AVP WebUI boot (recria /www/user após reboot) ---
{
  # /www é volátil; recriar diretório e links sempre
  mkdir -p /www/user 2>/dev/null

  # WebUI page
  [ -f /jffs/scripts/avp/www/avp.asp ] && ln -sf /jffs/scripts/avp/www/avp.asp /www/user/avp.asp

  # JSON (se existir em /jffs/scripts/avp/www, expõe em /www/user também)
  ln -sf /jffs/scripts/avp/www/avp-status.json /www/user/avp-status.json 2>/dev/null

  # sobe feeder (idempotente)
  [ -x /jffs/scripts/avp/bin/avp-webui-feed.sh ] && /jffs/scripts/avp/bin/avp-webui-feed.sh start >/dev/null 2>&1
} &

# ============================================================
# AVP BOOTSTRAP: Action Layer Initialization (WOPU 3A)
# ============================================================

# Ensure last-action JSON exists at boot
BOOT_TS="$(date +%s)"
BOOT_JSON="/jffs/scripts/avp/www/avp-action-last.json"

if [ ! -s "${BOOT_JSON}" ]; then
  echo "{\"ok\":true,\"rc\":0,\"action\":\"bootstrap\",\"msg\":\"boot init\",\"ts\":${BOOT_TS}}" > "${BOOT_JSON}"
fi

# Ensure WebUI symlink
mkdir -p /www/user 2>/dev/null || :
ln -sf "${BOOT_JSON}" /www/user/avp-action-last.json

# Trigger action pipeline once (state sync)
if [ -x /jffs/scripts/service-event ]; then
  /jffs/scripts/service-event restart avp_webui_restart >/dev/null 2>&1
fi

exit 0
