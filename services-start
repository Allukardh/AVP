#!/bin/sh
# ============================================================
# Component: AVP (AutoVPN Platform)
# File: services-start
# Role: Boot bootstrap (Merlin hook)
# Status: ACTIVE
# Version: v1.0.19 (2026-02-14)
# SCRIPT_VER="v1.0.19"
# ============================================================

# --- PATH safety ---
export PATH="/jffs/scripts:/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin:${PATH:-}"

# --- Ensure runtime dirs ---
mkdir -p /www/user
mkdir -p /jffs/addons/avp/www
mkdir -p /tmp/avp_logs

# --- Reinforce permissions (idempotent) ---
[ -f /jffs/scripts/service-event ] && chmod 0755 /jffs/scripts/service-event
[ -f /jffs/scripts/avp-action.sh ] && chmod 0755 /jffs/scripts/avp-action.sh
[ -f /jffs/scripts/avp-webui-feed.sh ] && chmod 0755 /jffs/scripts/avp-webui-feed.sh

# --- WebUI status symlink ---
ln -sf /jffs/addons/avp/www/avp-status.json /www/user/avp-status.json

# --- Start WebUI feeder (background) ---
if [ -x /jffs/scripts/avp-webui-feed.sh ]; then
  /jffs/scripts/avp-webui-feed.sh start >/dev/null 2>&1
fi

# ============================================================
# BOOTSTRAP ACTION LAYER (NEW)
# ============================================================

# --- Create minimal last-action bootstrap JSON ---
BOOT_TS="$(date +%s)"
BOOT_JSON="/jffs/addons/avp/www/avp-action-last.json"

echo "{\"ok\":true,\"rc\":0,\"action\":\"bootstrap\",\"msg\":\"boot init\",\"ts\":${BOOT_TS}}" > "${BOOT_JSON}"

# --- Ensure WebUI symlink ---
ln -sf "${BOOT_JSON}" /www/user/avp-action-last.json

# --- Trigger action pipeline once (state sync) ---
if [ -x /jffs/scripts/service-event ]; then
  /jffs/scripts/service-event restart avp_webui_restart >/dev/null 2>&1
fi

exit 0
